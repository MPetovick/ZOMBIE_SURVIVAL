<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeoCraft — Juego de Geolocalización</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2A6kGg3gXk2sH5a1mM2Z4VbM9s3i0zj5xXv+0mM=" crossorigin=""/>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#3b82f6;--muted:#94a3b8;--good:#10b981;--danger:#ef4444;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    html,body,#app{height:100%;margin:0;background:linear-gradient(180deg,#071028 0%, #031124 100%);color:#e6eef8}
    #app{display:grid;grid-template-columns:1fr 360px;gap:18px;padding:18px}
    /* Map container */
    #map{border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.6);overflow:hidden;border:1px solid rgba(255,255,255,.03);min-height:720px}
    /* Sidebar */
    .sidebar{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));padding:18px;border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.6);display:flex;flex-direction:column;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:54px;height:54px;background:linear-gradient(135deg,var(--accent),#06b6d4);border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:20px;color:white}
    h1{font-size:16px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,.02));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.03)}
    .meter{height:10px;background:rgba(255,255,255,.04);border-radius:8px;overflow:hidden}
    .meter > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#06b6d4);width:40%}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:transparent;border:1px solid rgba(255,255,255,.06);padding:8px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#06b6d4);color:#021025;border:none}
    .map-overlay{position:absolute;left:18px;top:18px;z-index:1000;background:rgba(2,6,23,.6);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.03);backdrop-filter: blur(6px)}
    .poi-list{max-height:200px;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:6px}
    .poi{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.02);background:linear-gradient(180deg, rgba(255,255,255,.008), transparent)}
    .inventory{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .item{padding:8px;background:rgba(255,255,255,.02);border-radius:8px;border:1px solid rgba(255,255,255,.02);text-align:center;font-size:13px}
    .hud{position:absolute;right:24px;bottom:24px;z-index:1000;display:flex;flex-direction:column;gap:8px}
    .toast{background:#061226;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.03);min-width:220px}
    .xpbar{display:flex;gap:8px;align-items:center}
    .big{font-size:22px;font-weight:700}
    .subtle{opacity:.85}
    /* Responsive */
    @media (max-width:1000px){#app{grid-template-columns:1fr;grid-auto-rows:1fr} .sidebar{order:2}}
  </style>
</head>
<body>
  <div id="app">
    <div id="map" aria-label="Mapa de juego"></div>

    <aside class="sidebar" aria-label="Panel de control">
      <div class="brand"><div class="logo">GC</div><div><h1>GeoCraft</h1><div class="muted">Explora. Descubre. Craftea.</div></div></div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="big" id="player-name">Jugador</div>
            <div class="muted">Nivel <span id="player-level">1</span> • XP <span id="player-xp">0</span>/<span id="player-xp-needed">100</span></div>
          </div>
          <div style="text-align:right">
            <div class="muted">Monedas</div>
            <div class="big" id="player-coin">0</div>
          </div>
        </div>
        <div style="margin-top:10px">
          <div class="xpbar"><div class="meter" style="flex:1"><i id="xp-fill"></i></div><div class="muted" id="player-hp">HP 100</div></div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="muted">Inventario</div><button class="btn" id="btn-clear-inv" title="Vaciar inventario">Vaciar</button></div>
        <div class="inventory" id="inventory"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="muted">Crafteo</div><button class="btn primary" id="open-craft">Abrir</button></div>
        <div id="recipe-preview" class="muted">Recetas desbloqueadas aparecerán aquí.</div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="muted">Misiones rápidas</div><button class="btn" id="btn-new-quest">Nueva</button></div>
        <div id="quest-box" class="muted">Sin misión activa.</div>
      </div>

      <div style="margin-top:auto;display:flex;gap:8px;justify-content:space-between;align-items:center">
        <div class="muted">Progreso guardado automáticamente</div>
        <div style="display:flex;gap:8px"><button class="btn" id="btn-sim-move">Simular</button><button class="btn" id="btn-teleport">Telep.</button></div>
      </div>
    </aside>

    <div class="map-overlay" id="overlay">
      <div style="display:flex;gap:8px;align-items:center"><strong class="muted">Estado:</strong> <span id="status">Esperando ubicación / modo teclado</span></div>
      <div style="margin-top:8px" class="poi-list" id="poi-list"></div>
    </div>

    <div class="hud" id="hud" aria-hidden="false"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j8tT+uZ5F+1qg4j4k0s0ZQbS8s3b4m2k9Zx0k8w=" crossorigin=""></script>
  <script>
    // --- Game constants and utils ---
    const CONFIG = {
      discoveryRadius: 35, // meters
      poiSpawnRadiusMeters: 800,
      maxPOI: 12,
      tickMs: 1000/30,
      levelXPBase: 100,
      recipes: {
        'Campamento': {wood:4,stone:2,craftXP:30},
        'Antorcha': {wood:2,coal:1,craftXP:10},
        'PicoMejorado': {wood:3,stone:5,iron:2,craftXP:60}
      }
    }

    // --- Simple audio feedback ---
    function beep(freq=440, time=0.06, vol=0.03){ try{const a=new (window.AudioContext||window.webkitAudioContext)();const o=a.createOscillator();const g=a.createGain();o.frequency.value=freq;g.gain.value=vol;o.connect(g);g.connect(a.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001,a.currentTime+time);o.stop(a.currentTime+time+0.02);}catch(e){} }

    // --- Storage helpers ---
    const STORAGE_KEY='geocraft_v1';
    function save(state){localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); document.getElementById('status').innerText='Guardado '+(new Date()).toLocaleTimeString();}
    function load(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||null}catch(e){return null}}

    // --- Player state ---
    let state = load() || {
      player:{name:'Jugador',level:1,xp:0,coin:0,hp:100},
      inventory:{wood:0,stone:0,iron:0,coal:0,campamento:0},
      unlockedRecipes:['Antorcha'],
      pois:[],quests:[],lastPos:null
    }

    // --- Map setup ---
    const map = L.map('map',{zoomControl:true,preferCanvas:true}).setView([40.4168,-3.7038],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap contributors'}).addTo(map);

    // Player marker
    const playerIcon = L.divIcon({className:'player-icon',html:'<div style="width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#06b6d4);box-shadow:0 4px 8px rgba(3,16,35,.6);border:2px solid rgba(255,255,255,.9)"></div>',iconSize:[28,28],iconAnchor:[14,14]});
    const playerMarker = L.marker([40.4168,-3.7038],{icon:playerIcon,interactive:false}).addTo(map);

    // POI group
    const poiLayer = L.layerGroup().addTo(map);

    // HUD / DOM refs
    const inventoryEl = document.getElementById('inventory');
    const poiListEl = document.getElementById('poi-list');
    const hudEl = document.getElementById('hud');

    // --- POI logic ---
    function randomOffset(meters){
      const r = Math.random()*meters; const ang = Math.random()*Math.PI*2; const dx = r*Math.cos(ang); const dy = r*Math.sin(ang);
      // approx degrees per meter
      const lat = dx/111320; const lon = dy/(111320*Math.cos(map.getCenter().lat*Math.PI/180));
      return [lat,lon];
    }

    function spawnPOI(center){
      while(state.pois.length < CONFIG.maxPOI){
        const off = randomOffset(CONFIG.poiSpawnRadiusMeters);
        const lat = center[0]+off[0]; const lon = center[1]+off[1];
        const types=['wood','stone','iron','coal','mystery'];
        const type = types[Math.floor(Math.random()*types.length)];
        const poi = {id:cryptoRandomId(),lat,lon,type,discovered:false,name:capitalize(type)};
        state.pois.push(poi);
      }
      renderPOIs();
    }

    function cryptoRandomId(){return Math.random().toString(36).slice(2,9)}
    function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1)}

    function renderPOIs(){poiLayer.clearLayers(); poiListEl.innerHTML='';
      state.pois.forEach(p=>{
        const iconHtml = `<div style="width:36px;height:36px;border-radius:8px;display:grid;place-items:center;border:1px solid rgba(255,255,255,.04);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)">${emojiFor(p.type)}</div>`;
        const marker = L.marker([p.lat,p.lon],{icon:L.divIcon({className:'poi-icon',html:iconHtml,iconSize:[36,36],iconAnchor:[18,18]})}).addTo(poiLayer);
        marker.on('click',()=>attemptDiscover(p));
        const li = document.createElement('div'); li.className='poi'; li.innerHTML=`<div><strong>${p.name}</strong><div class="muted">${p.type==='mystery'?'Puede contener recursos raros':p.type}</div></div><div><button class="btn" onclick="window.attemptDiscoverFromList('${p.id}')">Ir/Descubrir</button></div>`;
        poiListEl.appendChild(li);
      });
    }

    window.attemptDiscoverFromList = function(id){const p=state.pois.find(x=>x.id===id);if(!p) return;map.panTo([p.lat,p.lon]);attemptDiscover(p)}

    function emojiFor(t){switch(t){case 'wood':return '🌲';case 'stone':return '🪨';case 'iron':return '⛏️';case 'coal':return '⚫';case 'mystery':return '✨';default:return '❓'}}

    // --- Discovery and resource logic ---
    function metersBetween(a,b){const R=6371000;const φ1=a[0]*Math.PI/180;const φ2=b[0]*Math.PI/180;const Δφ=(b[0]-a[0])*Math.PI/180;const Δλ=(b[1]-a[1])*Math.PI/180;const aa=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);const c=2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));return R*c}

    function attemptDiscover(poi){const pos = playerMarker.getLatLng(); const dist = metersBetween([pos.lat,pos.lng],[poi.lat,poi.lon]); if(dist <= CONFIG.discoveryRadius){if(!poi.discovered){poi.discovered=true;handleDiscovery(poi);}else{toast('Ya descubierto.');}} else {toast(`Estás a ${Math.round(dist)} m — acércate para descubrir`)} }

    function handleDiscovery(poi){beep(720,0.07,0.06);toast(`Descubriste: ${poi.name}`);
      // reward based on type
      let gained={};
      if(poi.type==='wood'){gained.wood=3;state.player.xp+=8}
      else if(poi.type==='stone'){gained.stone=3;state.player.xp+=10}
      else if(poi.type==='iron'){gained.iron=2;state.player.xp+=18}
      else if(poi.type==='coal'){gained.coal=2;state.player.xp+=12}
      else if(poi.type==='mystery'){const roll=Math.random(); if(roll<0.6){gained.wood=4;state.player.xp+=12}else if(roll<0.9){gained.iron=2;state.player.xp+=30;state.player.coin+=10}else{gained.coal=3;state.player.xp+=40;state.unlockedRecipes.push('Campamento') }

      // apply gains
      for(const k in gained){state.inventory[k]=(state.inventory[k]||0)+gained[k]}
      // small coin reward
      state.player.coin += Math.floor(Math.random()*3);
      // mark poi removed after discovery
      state.pois = state.pois.filter(x=>x.id!==poi.id);
      spawnPOI([playerMarker.getLatLng().lat,playerMarker.getLatLng().lng]);
      updateUI(); save(state);
    }

    // --- Crafting ---
    function openCraft(){const modal=document.createElement('div');modal.style.position='fixed';modal.style.inset='0';modal.style.display='grid';modal.style.placeItems='center';modal.style.zIndex=9999;modal.innerHTML=`
      <div style="width:720px;background:${'rgba(3,10,20,.96)'};padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.03)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 style="margin:0">Crafteo</h3><button id="closeCraft" class="btn">Cerrar</button></div>
        <div style="display:grid;grid-template-columns:1fr 320px;gap:12px">
          <div id="recipesCol"></div>
          <div class="card" style="height:100%"><div class="muted">Detalles</div><div id="recipeDetails" style="margin-top:8px"></div></div>
        </div>
      </div>`;
      document.body.appendChild(modal);
      document.getElementById('closeCraft').onclick=()=>modal.remove();
      const rc=document.getElementById('recipesCol'); rc.innerHTML='';
      state.unlockedRecipes = Array.from(new Set(state.unlockedRecipes));
      state.unlockedRecipes.forEach(r=>{
        const recipe=CONFIG.recipes[r]||null; const el=document.createElement('div');el.className='card';el.style.display='flex';el.style.justifyContent='space-between';el.style.alignItems='center';el.innerHTML=`<div><strong>${r}</strong><div class="muted">${recipe?Object.entries(recipe).filter(x=>x[0]!=='craftXP').map(x=>x[0]+': '+x[1]).join(' • '):'Receta misteriosa'}</div></div><div><button class="btn primary">Craftear</button></div>`;
        rc.appendChild(el);
        el.querySelector('button').onclick=()=>{
          craft(r);
          document.getElementById('recipeDetails').innerText = 'Crafteado: '+r;
        }
      })
    }

    function craft(name){const recipe=CONFIG.recipes[name]; if(!recipe){toast('Receta inválida');return}
      // check resources
      for(const key of Object.keys(recipe)){if(key==='craftXP') continue; if((state.inventory[key]||0) < recipe[key]){toast('No tienes recursos suficientes');beep(220,0.05,0.02);return}}
      // consume
      for(const key of Object.keys(recipe)){if(key==='craftXP') continue; state.inventory[key]-=recipe[key]}
      // reward crafted item
      const craftedKey = name.toLowerCase(); state.inventory[craftedKey] = (state.inventory[craftedKey]||0)+1; state.player.xp += recipe.craftXP||10; toast('Crafteaste '+name);beep(1100,0.07,0.05); updateUI(); save(state);
    }

    // --- Quests ---
    function newQuest(){const tasks=['Descubre 3 POIs próximos','Recolecta 5 madera','Craftea una Antorcha']; const t=tasks[Math.floor(Math.random()*tasks.length)]; state.quests=[{id:cryptoRandomId(),title:t,progress:0,goal: t.includes('3')?3:(t.includes('5')?5:1)}]; updateUI(); save(state); toast('Nueva misión: '+t)}

    // --- Movement systems: geolocation + keyboard simulation ---
    let geolocationEnabled=false; let simulatedMode=false; let lastKnown=null;
    function enableGeolocation(){if(!navigator.geolocation){document.getElementById('status').innerText='Geolocalización no disponible'; return}
      navigator.geolocation.getCurrentPosition(pos=>{
        geolocationEnabled=true; simulatedMode=false; lastKnown=[pos.coords.latitude,pos.coords.longitude]; playerMarker.setLatLng(lastKnown); map.setView(lastKnown,15); document.getElementById('status').innerText='Modo GPS activo'; spawnPOI(lastKnown); updateUI(); save(state);
      },err=>{document.getElementById('status').innerText='Permiso denegado — usa teclado/simular'} ,{enableHighAccuracy:true,maximumAge:20000})
      // watch position
      navigator.geolocation.watchPosition(pos=>{if(!geolocationEnabled) return; lastKnown=[pos.coords.latitude,pos.coords.longitude]; playerMarker.setLatLng(lastKnown); checkNearby(); save(state)},{enableHighAccuracy:true,maximumAge:10000})
    }

    // keyboard movement for testing and users without GPS
    const keys = {up:false,down:false,left:false,right:false}; let moveSpeed=0.0004; // degrees per tick approx
    document.addEventListener('keydown',e=>{if(e.key==='ArrowUp'||e.key==='w'){keys.up=true} if(e.key==='ArrowDown'||e.key==='s'){keys.down=true} if(e.key==='ArrowLeft'||e.key==='a'){keys.left=true} if(e.key==='ArrowRight'||e.key==='d'){keys.right=true}})
    document.addEventListener('keyup',e=>{if(e.key==='ArrowUp'||e.key==='w'){keys.up=false} if(e.key==='ArrowDown'||e.key==='s'){keys.down=false} if(e.key==='ArrowLeft'||e.key==='a'){keys.left=false} if(e.key==='ArrowRight'||e.key==='d'){keys.right=false}})

    function simulateTick(){if(simulatedMode){const pos=playerMarker.getLatLng(); let lat=pos.lat; let lon=pos.lng; if(keys.up) lat+=moveSpeed; if(keys.down) lat-=moveSpeed; if(keys.left) lon-=moveSpeed; if(keys.right) lon+=moveSpeed; playerMarker.setLatLng([lat,lon]); map.setView([lat,lon]); checkNearby(); save(state)} }

    document.getElementById('btn-sim-move').onclick=()=>{simulatedMode=!simulatedMode; geolocationEnabled=false; document.getElementById('status').innerText = simulatedMode ? 'Modo simulación: usa WASD/arrow' : 'Modo sim detenido'; toast('Simulación '+(simulatedMode?'activada':'desactivada'));}
    document.getElementById('btn-teleport').onclick=()=>{const c=map.getCenter(); playerMarker.setLatLng(c); toast('Teletransportado al centro del mapa'); checkNearby(); save(state)}

    // check nearby POIs automatically
    function checkNearby(){const pos=[playerMarker.getLatLng().lat,playerMarker.getLatLng().lng]; // discover any within small radius automatically
      const close = state.pois.filter(p=>metersBetween([p.lat,p.lon],pos) <= CONFIG.discoveryRadius);
      close.forEach(p=>handleDiscovery(p)); updateUI();
    }

    // --- UI updates ---
    function updateUI(){document.getElementById('player-name').innerText=state.player.name;document.getElementById('player-level').innerText=state.player.level;document.getElementById('player-xp').innerText=state.player.xp;document.getElementById('player-xp-needed').innerText=levelXPNeeded(state.player.level);
      const percent = Math.min(100, Math.round((state.player.xp/levelXPNeeded(state.player.level))*100)); document.getElementById('xp-fill').style.width = percent+'%'; document.getElementById('player-coin').innerText = state.player.coin; document.getElementById('player-hp').innerText = 'HP '+state.player.hp;
      // inventory render
      inventoryEl.innerHTML=''; for(const k of Object.keys(state.inventory)){const el=document.createElement('div');el.className='item'; el.innerHTML=`<div style="font-weight:700">${state.inventory[k]}</div><div style="font-size:11px" class="muted">${capitalize(k)}</div>`; inventoryEl.appendChild(el)}
      renderPOIs(); renderQuests();
      // level up
      const needed = levelXPNeeded(state.player.level); if(state.player.xp >= needed){state.player.xp -= needed; state.player.level++; state.player.hp += 10; state.player.coin += 20; toast('Subiste de nivel! Nivel '+state.player.level); beep(1400,0.08,0.06); updateUI();}
    }

    function levelXPNeeded(level){return Math.round(CONFIG.levelXPBase * Math.pow(1.25,level-1)); }

    function renderQuests(){const qb=document.getElementById('quest-box'); if(!state.quests||state.quests.length===0){qb.innerText='Sin misión activa.';return} const q=state.quests[0]; qb.innerHTML=`<div style="font-weight:700">${q.title}</div><div class="muted">Progreso ${q.progress}/${q.goal}</div>`}

    // toasts
    function toast(text,t=3500){const d=document.createElement('div');d.className='toast';d.innerText=text;hudEl.appendChild(d);setTimeout(()=>d.style.opacity='0.0',t-400);setTimeout(()=>d.remove(),t)}

    // UI buttons
    document.getElementById('open-craft').onclick=openCraft; document.getElementById('btn-new-quest').onclick=newQuest; document.getElementById('btn-clear-inv').onclick=()=>{state.inventory={}; updateUI(); toast('Inventario vaciado'); save(state)}

    // auto spawn initial POIs around center
    spawnPOI(map.getCenter()); updateUI();

    // attempt geolocation on load
    enableGeolocation();

    // main loop
    let lastTick = performance.now(); function loop(now){ const dt = now-lastTick; if(dt >= CONFIG.tickMs){simulateTick(); lastTick=now;} requestAnimationFrame(loop)} requestAnimationFrame(loop);

    // small helper: unlock recipe when player reaches XP thresholds
    setInterval(()=>{if(state.player.level >= 2 && !state.unlockedRecipes.includes('Campamento')){state.unlockedRecipes.push('Campamento'); toast('Nueva receta desbloqueada: Campamento'); save(state)}},5000);

    // expose some functions to console for debugging
    window._debug = {state,save,load,craft,spawnPOI};

  </script>
</body>
</html>
